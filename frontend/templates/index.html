{% extends "base.html" %}
{% load static %}
<title>Lcic-HR - ລະບົບບໍລິຫານ ແລະ ຈັດການພາຍໃນ</title>
{% block content %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
    
    <!-- Page Heading -->
    <div class="dashboard-header ml-2">
        <h1><i class="fas fa-tachometer-alt"></i> ລະບົບບໍລິຫານ ແລະ ຈັດການພາຍໃນ</h1>            
    </div>

    <!-- Content Row -->
    <div class="row ml-1">
        <!-- Document Management -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dropdown">
                <div class="card border-left-primary shadow h-100 py-2" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-sm font-weight-bold text-primary mb-3">
                                    ຈັດການເອກະສານ
                                </div>
                                <div class="text-xs text-gray-600">ຄລິກເພື່ອຈັດການຂໍ້ມູນເອກະສານ</div>                                 
                            </div>                               
                            <div class="col-auto">
                                <i class="fa fa-folder fa-2x text-primary"></i>
                            </div>
                            <i class="fa fa-folder card-icon text-primary"></i>
                        </div>
                    </div>
                </div>
                <ul class="dropdown-menu shadow" style="width: 100%">
                    <li>
                        <a class="dropdown-item" href="/documentEntry/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-primary mr-3">move_to_inbox</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ເອກະສານຂາເຂົ້າ</div>
                                    <div class="text-xs text-gray-500">ຈັດການເອກະສານຂາເຂົ້າ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/documentOut/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-primary mr-3">outbox</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ເອກະສານຂາອອກ</div>
                                    <div class="text-xs text-gray-500">ຈັດການເອກະສານຂາອອກ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/documentGen/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-primary mr-3">assignment_add</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ເອກະສານທົ່ວໄປ</div>
                                    <div class="text-xs text-gray-500">ຈັດການເອກະສານທົ່ວໄປ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dropdown">
                <div class="card border-left-success shadow h-100 py-2" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-sm font-weight-bold text-success mb-3">
                                    ຈັດການຂໍ້ມູນພະນັກງານ
                                </div>
                                <div class="text-xs text-gray-600">ຄລິກເພື່ອຈັດການຂໍ້ມູນພະນັກງານ</div>                                 
                            </div>                               
                            <div class="col-auto">
                                <i class="fa fa-users fa-2x text-success"></i>
                            </div>
                            <i class="fa fa-users card-icon text-success"></i>
                        </div>
                    </div>
                </div>
                <ul class="dropdown-menu shadow" style="width: 100%">
                    <li>
                        <a class="dropdown-item" href="/form_emp/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-success mr-3">person_add</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ບັນທຶກຂໍ້ມູນພະນັກງານ</div>
                                    <div class="text-xs text-gray-500">ເພີ່ມຫຼືແກ້ໄຂຂໍ້ມູນພະນັກງານ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/tables_emp/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-success mr-3">visibility</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ສະແດງຂໍ້ມູນພະນັກງານ</div>
                                    <div class="text-xs text-gray-500">ເບິ່ງລາຍລະອຽດພະນັກງານ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dropdown">
                <div class="card border-left-info shadow h-100 py-2" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-sm font-weight-bold text-info mb-3">ຈັດການຊັບສີນ</div>
                                <div class="text-xs text-gray-600">ຄລິກເພື່ອຈັດການຂໍ້ມູນຊັບສີນ</div>                               
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clipboard-list fa-2x text-info"></i>
                            </div>
                            <i class="fas fa-clipboard-list card-icon text-info"></i>
                        </div>
                    </div>
                </div>
                <ul class="dropdown-menu shadow" style="width: 100%">
                    <li>
                        <a class="dropdown-item" href="#">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-info mr-3">inventory</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ເພີ່ມຊັບສີນ</div>
                                    <div class="text-xs text-gray-500">ບັນທຶກຊັບສີນໃໝ່</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-info mr-3">assignment</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ລາຍງານຊັບສີນ</div>
                                    <div class="text-xs text-gray-500">ເບິ່ງລາຍການຊັບສີນທັງໝົດ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/homeSalary">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-info mr-3">payments</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ໄລ່ເງິນພະນັກງານ</div>
                                    <div class="text-xs text-gray-500">ຈັດການເງິນເດືອນແລະການໄລ່ເງິນ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dropdown">
                <div class="card border-left-warning shadow h-100 py-2" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-sm font-weight-bold text-warning mb-3">
                                    ຈັດການຂໍ້ມູນທົ່ວໄປ</div>
                                <div class="text-xs text-gray-600">ຄລິກເພື່ອຈັດການຂໍ້ມູນຂອງລະບົບ</div>
                            </div>
                            <div class="col-auto">                                   
                                <i class="material-icons fa-2x text-warning">queue</i>
                            </div>
                            <i class="material-icons card-icon text-warning">settings</i>
                        </div>
                    </div>
                </div>
                <ul id="generalDataMenu" class="dropdown-menu shadow" style="width: 100%">
                    <!-- ສ່ວນນີ້ຈະເພີ່ມ "ເພີ່ມຜູ້ໃຊ້" ດ້ວຍ JavaScript -->
                    <!-- ເມນູອື່ນທີ່ບໍ່ກ່ຽວກັບ admin ຢູ່ໃນ HTML -->
                    <li>
                        <a class="dropdown-item" href="/department/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-warning mr-3">business</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ຂໍ້ມູນພະແນກ</div>
                                    <div class="text-xs text-gray-500">ຈັດການຂໍ້ມູນພະແນກ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/doc_format/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-warning mr-3">category</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ປະເພດເອກະສານ</div>
                                    <div class="text-xs text-gray-500">ຈັດການປະເພດເອກະສານ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/position/">
                            <div class="d-flex align-items-center">
                                <span class="material-icons text-warning mr-3">person_pin</span>
                                <div>
                                    <div class="text-sm font-weight-bold">ຂໍ້ມູນຕຳແໜ່ງ</div>
                                    <div class="text-xs text-gray-500">ຈັດການຂໍ້ມູນຕຳແໜ່ງ</div>
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row m-1">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 bg-primary">
                    <h6 class="m-0 font-weight-bold text-white">ແຈ້ງການ ແລະ ຂ່າວສານ</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th class="text-center" style="width: 40px;">ລ/ດ</th>                               
                                    <th class="text-start" style="width: 400px;">ເນື້ອໃນ</th>
                                    <th class="text-center" style="width: 200px;">ພະແນກ</th>
                                    <th class="text-center" style="width: 70px;">ລົງວັນທີ່</th>                 
                                    <th class="text-center" style="width: 40px;">ໄຟລ໌</th>                
                                </tr>
                            </thead>                     
                            <tbody id="dataTableBody">
                            </tbody>
                        </table>
                    </div> 
                    <a href="/view_post/" class="view-more-btn" style="text-decoration: none;">ເບິ່ງທັງໝົດ</a>
                </div>
            </div>
        </div>
    </div>


    <!-- Stats Section -->
    <div class="stats-container mx-2">
        <div class="stats-header">
            <h5 class="text-primary m-0 font-weight-bold">ສະຖິຕິລະບົບ</h5>
            <div>
                <select class="form-select form-select-sm">
                    <option selected>ປະຈຳວັນນີ້</option>
                    <option>ປະຈຳອາທິດ</option>
                    <option>ປະຈຳເດືອນ</option>
                </select>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="text-xs text-primary">ພະນັກງານທັງໝົດ</div>
                <div class="number">25</div>
                <div class="text-xs text-success">+0 ຄົນໃນເດືອນນີ້</div>
            </div>
            <div class="stat-card" style="border-left-color: #1cc88a;">
                <div class="text-xs text-success">ເອກະສານຂາເຂົ້າ</div>
                <div class="number" id="ingoing-docs-count">0</div>
                <div class="text-xs text-gray-600">ໃນເດືອນນີ້</div>
            </div>
            <div class="stat-card" style="border-left-color: #36b9cc;">
                <div class="text-xs text-info">ເອກະສານຂາອອກ</div>
                <div class="number" id="outgoing-docs-count">0</div>
                <div class="text-xs text-gray-600">ໃນເດືອນນີ້</div>
            </div>
            <div class="stat-card" style="border-left-color: #f6c23e;">
                <div class="text-xs text-warning">ຊັບສີນທັງໝົດ</div>
                <div class="number">ກຳລັງພັດທະນາ..</div>
                <div class="text-xs text-success">ກຳລັງພັດທະນາ..</div>
            </div>
        </div>
    </div>
</div>

       
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // ດຶງ userRole ຈາກ localStorage
    const userRole = localStorage.getItem("user_role");
    // ຟັງຊັນສຳລັບເພີ່ມເມນູ "ເພີ່ມຜູ້ໃຊ້" ຖ້າເປັນ admin
    function renderAdminMenu() {
        const menuContainer = document.getElementById("generalDataMenu");
        // ກວດສອບວ່າ userRole ເປັນ "admin" ຫຼືບໍ່
        if (userRole === "admin") {
            // ສ້າງແທັກ <li> ສຳລັບ "ເພີ່ມຜູ້ໃຊ້" ພ້ອມກຳນົດສະເພາະ
            const adminMenuItem = document.createElement("li");
            adminMenuItem.id = "menu-add-user"; // ກຳນົດ ID
            adminMenuItem.className = "menu-item-admin"; // ກຳນົດ Class
            adminMenuItem.setAttribute("data-role", "admin-only"); // ກຳນົດ Data Attribute
            // ໃສ່ເນື້ອຫາພາຍໃນ <li>
            adminMenuItem.innerHTML = `
                <a class="dropdown-item" href="/register/">
                    <div class="d-flex align-items-center">
                        <span class="material-icons text-warning mr-3">person_add</span>
                        <div>
                            <div class="text-sm font-weight-bold">ເພີ່ມຜູ້ໃຊ້</div>
                            <div class="text-xs text-gray-500">ເພີ່ມຜູ້ໃຊ້ລະບົບໃໝ່</div>
                        </div>
                    </div>
                </a>
            `;
            // ເພີ່ມ <li> ໄປທີ່ຕຳແໜ່ງທຳອິດຂອງ dropdown menu
            menuContainer.insertBefore(adminMenuItem, menuContainer.firstChild);
        }
    }
    document.addEventListener("DOMContentLoaded", async function() {
        renderAdminMenu();
        const DATABASE_URL = "{{ database_url | escapejs }}";  
        let showingAll = false;
        let allDocuments = [];
        const department = localStorage.getItem('department_name'); // ດຶງ department ຈາກ localStorage
        // console.log("Department from localStorage:", department);
    
        // ຟັງຊັນເພື່ອດືງຂໍ້ມູນເອກະສານຂາອອກ
        async function fetchOutgoingDocs() {
            const outgoingApiUrl = `${DATABASE_URL}/api/search/document_lcic/?doc_type=ຂາອອກ&department=${department}`;
            try {
                const response = await fetch(outgoingApiUrl);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const outgoingDocs = await response.json();
                return outgoingDocs.length;
            } catch (error) {
                // console.error("Error fetching outgoing documents:", error);
                return 0;
            }
        }
    
        // ຟັງຊັນເພື່ອດືງຂໍ້ມູນເອກະສານຂາເຂົ້າ
        async function fetchIngoingDocs() {
            const ingoingApiUrl = `${DATABASE_URL}/api/search/document_lcic/?doc_type_info=ຂາເຂົ້າ&department_into=${department}`;
            try {
                const response = await fetch(ingoingApiUrl);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const ingoingDocs = await response.json();
                return ingoingDocs.length;
            } catch (error) {
                console.error("Error fetching ingoing documents:", error);
                return 0;
            }
        }
    
        async function fetchData(showAll = false) { 
            const documentApiUrl = `${DATABASE_URL}/api/search/document_general/?status_doc=1`;
            const departmentApiUrl = `${DATABASE_URL}/api/list/departments/`;
            const formatApiUrl = `${DATABASE_URL}/api/list/Document_format/`;
        
            const urlParams = new URLSearchParams(window.location.search);
            const formatFilter = urlParams.get('format') || '';
            const startDateFilter = urlParams.get('start_date') || '';
            const endDateFilter = urlParams.get('end_date') || '';
           
            try {
                const [documentsRes, departmentsRes, formatsRes] = await Promise.all([
                    fetch(documentApiUrl),
                    fetch(departmentApiUrl),
                    fetch(formatApiUrl)
                ]);
        
                const documents = documentsRes.ok ? await documentsRes.json() : [];
                const departments = departmentsRes.ok ? await departmentsRes.json() : [];
                const formats = formatsRes.ok ? await formatsRes.json() : [];
        
                const departmentMap = Object.fromEntries(departments.map(d => [d.id, d.name]));
                const formatMap = Object.fromEntries(formats.map(f => [f.dmf_id, f.name]));
        
                const processedDocuments = documents.map((doc, index) => ({
                    index: index + 1,
                    docg_id: doc.docg_id || 'N/A',
                    doc_number: doc.doc_number || 'N/A',
                    format_id: doc.format || null,
                    format_name: formatMap[doc.format] || 'N/A',
                    subject: doc.subject || 'N/A',
                    insert_date: doc.insert_date || 'N/A',
                    department_id: doc.department || null,
                    department: departmentMap[doc.department] || 'N/A',
                    name: doc.name || 'N/A',
                    file: doc.file ? `${DATABASE_URL}/${doc.file}` : '#'
                }));
                // console.log("sdfsdf:", processedDocuments);
                const sortedDocuments = processedDocuments.sort((a, b) => {
                    return new Date(b.insert_date) - new Date(a.insert_date);
                });
        
                allDocuments = sortedDocuments;
                
                const filteredDocuments = sortedDocuments.filter(doc => {
                    const docDate = new Date(doc.insert_date);
                    return (!formatFilter || doc.format_id.toString() === formatFilter) &&
                            (!startDateFilter || docDate >= new Date(startDateFilter)) &&
                            (!endDateFilter || docDate <= new Date(endDateFilter));
                });
        
                return showAll ? filteredDocuments : filteredDocuments.slice(0, 8);
            } catch (error) {
                console.error("Error fetching API data:", error);
                return [];
            }
        }
        
        function renderTable(documents) {
            const tableBody = document.getElementById("dataTableBody");
            tableBody.innerHTML = '';
        
            if (!documents?.length) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">ບໍ່ພົບຂໍ້ມູນ</td></tr>';
                return;
            }
        
            const fragment = document.createDocumentFragment();
            documents.forEach((doc, index) => {
                const tr = document.createElement('tr');
                tr.dataset.id = doc.docg_id;
                
                const dateObj = new Date(doc.insert_date);
                const formattedDate = dateObj.toLocaleDateString('en-GB', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                
                const newBadge = (index < 3) ? 
                    `<span class="badge badge-success ml-2 new-badge blink" 
                            style="cursor: pointer;" 
                            onclick="showDocDetails('${doc.docg_id}', '${doc.subject}', '${formattedDate}')">ໃໝ່</span>` : 
                    '';
                
                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${doc.subject || ''}${newBadge}</td>
                    <td class="text-center">${doc.department || ''}</td>
                    <td class="text-center">${formattedDate || ''}</td>
                    <td class="text-center">
                        <a href="${doc.file}" target="_blank" class="btn btn-sm btn-outline-primary btn-view-doc">
                            <i class="fas fa-file-pdf"></i> ເບິ່ງ
                        </a>
                    </td>
                `;
                fragment.appendChild(tr);
            });
        
            tableBody.appendChild(fragment);
            
            const table = document.querySelector(".table");
            if (table) {
                table.classList.add("table-hover");
                
                let captionText = showingAll ? 
                    `ທັງໝົດ ${documents.length} ລາຍການ` : 
                    "5 ລາຍການແຈ້ງການລ່າສຸດ";
                
                const existingCaption = table.querySelector("caption");
                if (existingCaption) {
                    existingCaption.textContent = captionText;
                } else {
                    const caption = document.createElement("caption");
                    caption.textContent = captionText;
                    caption.style.captionSide = "top";
                    caption.style.textAlign = "right";
                    caption.style.color = "#4e73df";
                    caption.style.fontWeight = "bold";
                    caption.style.padding = "0.5rem";
                    table.appendChild(caption);
                }
            }
    
            const viewAllBtn = document.getElementById("viewAllBtn");
            if (viewAllBtn) {
                viewAllBtn.textContent = showingAll ? "ສະແດງໜ້ອຍລົງ" : "ເບິ່ງທັງໝົດ";
            }
        }
        
        window.showDocDetails = function(docId, subject, date) {
            Swal.fire({
                title: 'ລາຍລະອຽດແຈ້ງການ',
                html: `
                    <p><strong>ເລກທີ່ເອກະສານ:</strong> ${docId}</p>
                    <p><strong>ເນື້ອໃນ:</strong> ${subject}</p>
                    <p><strong>ວັນທີ່:</strong> ${date}</p>
                `,
                icon: 'info',
                confirmButtonText: 'ປິດ'
            });
        }
        
        // ອັບເດດຈຳນວນເອກະສານຂາອອກ
        async function updateOutgoingDocsCount() {
            const totalOutgoingDocs = await fetchOutgoingDocs();
            const outgoingCountElement = document.getElementById("outgoing-docs-count");
            if (outgoingCountElement) {
                outgoingCountElement.textContent = totalOutgoingDocs;
            }
        }
    
        // ອັບເດດຈຳນວນເອກະສານຂາເຂົ້າ
        async function updateIngoingDocsCount() {
            const totalIngoingDocs = await fetchIngoingDocs();
            const ingoingCountElement = document.getElementById("ingoing-docs-count");
            if (ingoingCountElement) {
                ingoingCountElement.textContent = totalIngoingDocs;
            }
        }
    
        // ເລີ່ມຕົ້ນດືງຂໍ້ມູນ
        async function initializeData() {
            const documents = await fetchData();
            renderTable(documents);
            await updateOutgoingDocsCount(); // ອັບເດດຈຳນວນເອກະສານຂາອອກ
            await updateIngoingDocsCount(); // ອັບເດດຈຳນວນເອກະສານຂາເຂົ້າ
        }
    
        initializeData();
        
        const cardHeader = document.querySelector('.card-header.py-3.bg-primary');
        if (cardHeader) {
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn btn-sm btn-light float-right';
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            refreshBtn.addEventListener('click', async function() {
                const newDocuments = await fetchData(showingAll);
                renderTable(newDocuments);
                await updateOutgoingDocsCount(); // ອັບເດດຈຳນວນເອກະສານຂາອອກ
                await updateIngoingDocsCount(); // ອັບເດດຈຳນວນເອກະສານຂາເຂົ້າ
            });
            cardHeader.appendChild(refreshBtn);
        }
    
        const viewAllBtn = document.getElementById("viewAllBtn");
        if (viewAllBtn) {
            viewAllBtn.addEventListener("click", async function() {
                showingAll = !showingAll;
                const documentsToShow = await fetchData(showingAll);
                renderTable(documentsToShow);
            });
        }
    });
    </script>
    {% endblock %}