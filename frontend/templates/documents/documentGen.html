{% extends "base.html" %}
{% load static %}

<title>Lcic-HR</title>
{% block content %}
<div id="content ">
    <div class="card-header ">
        <button onclick="goBack()" class="btn-no-style mx-2">
            <i class="fas fa-arrow-left mr-2"></i>
        </button>
        <h2 class="mb-2 text-center fw-bold">ເອກະສານທົ່ວໄປ</h2>
    </div>
    <div class="cardd shadow mb-4 m-2">
        <div class="card-body">
            <div class="row p-6">
                <form method="GET" id="filterForm" class="row g-3 mb-4">
                    <div class="card-header d-flex justify-content-between">
                        <div class="row g-2 align-items-center"> 
                            <div class="col-md-3 col-6">
                                <select name="format" class="form-control filter-select">
                                    <option value="">ເອກະສານທັງໝົດ</option>
                                    {% for format in formats %}
                                    <option value="{{ format.dmf_id }}" {% if format.dmf_id|stringformat:"s" == format_filter %}selected{% endif %}>
                                        {{ format.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                
                            <!-- ช่องเลือกวันที่ -->
                            <div class="col-md-3 col-6">
                                <input type="date" name="start_date" class="form-control date-input" value="{{ start_date_filter }}">
                            </div>
                
                            
                
                            <div class="col-md-3 col-6">
                                <input type="date" name="end_date" class="form-control date-input" value="{{ end_date_filter }}">
                            </div>
                
                            <!-- ปุ่มกด -->
                            <div class="col-md-2 col-6 d-flex gap-2 justify-end">
                                <button type="submit" class="btn btn-info"><i class="fa fa-search"></i></button>
                                <button onclick="window.location.reload();" class="btn btn-danger" id="resetFilter">
                                    <i class="fas fa-sync"></i>
                                </button>
                                
                            </div>
                        </div>
                        <div>
                            <a href="/add_documentG/" class="btn btn-primary mx-2" style="width: 110px; border-radius: 20px;">
                                <i class="fas fa-plus-circle"></i>&nbsp;&nbsp;ເພີ່ມ
                            </a>
                        </div>
                    </div>
                </form>
                               
            </div>
            {% if error %}
                <div class="alert alert-danger" role="alert">
                    {{ error }}
                </div>
                {% endif %}
    
            <div class="table-responsive">
                <table id="dataTable"class="table table-bordered"  width="100%" cellspacing="0">
                    <thead class="thead-light">
                        <tr>
                            <th style="text-align: center; width: 50px;">ລ/ດ</th>
                            <th>ເລກທີ່</th>
                            <th>ປະເພດ</th>
                            <th>ເນື້ອໃນ</th>
                            <th>ວັນທີ່</th>
                            <!-- <th>ຈາກພະແນກ</th> -->
                            <!-- <th>ຫາພະແນກ</th> -->
                            <th>ຜູ້ສົ່ງ</th>
                            <th >ໄຟລ໌</th>
                            <!-- <th>ສະຖານະ</th> -->
                            <th>Action</th>
                        </tr>
                    </thead>                   
                    <tbody id="dataTableBody">
                        
                    </tbody>
                </table>
                
            </div>        
        </div>
    </div>
</div>
    
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
    document.addEventListener("DOMContentLoaded", async function() {
        const DATABASE_URL = "{{ database_url | escapejs }}";  
    
        async function fetchData() { 
            let department = localStorage.getItem("department_name");
            
            const documentApiUrl = `${DATABASE_URL}/api/search/document_general/?department=${department}`;
            const departmentApiUrl = `${DATABASE_URL}/api/list/departments/`;
            const formatApiUrl = `${DATABASE_URL}/api/list/Document_format/`;
        
            const urlParams = new URLSearchParams(window.location.search);
            const formatFilter = urlParams.get('format') || '';
            const startDateFilter = urlParams.get('start_date') || '';
            const endDateFilter = urlParams.get('end_date') || '';
        
            try {
                const [documentsRes, departmentsRes, formatsRes] = await Promise.all([
                    fetch(documentApiUrl),
                    fetch(departmentApiUrl),
                    fetch(formatApiUrl)
                ]);
        
                const documents = documentsRes.ok ? await documentsRes.json() : [];
                const departments = departmentsRes.ok ? await departmentsRes.json() : [];
                const formats = formatsRes.ok ? await formatsRes.json() : [];
        
                const departmentMap = Object.fromEntries(departments.map(d => [d.id, d.name]));
                const formatMap = Object.fromEntries(formats.map(f => [f.dmf_id, f.name]));
        
                const processedDocuments = documents.map((doc, index) => ({
                    index: index + 1,
                    docg_id: doc.docg_id || 'N/A',
                    doc_number: doc.doc_number || 'N/A',
                    format_id: doc.format || null,
                    format_name: formatMap[doc.format] || 'N/A',
                    subject: doc.subject || 'N/A',
                    insert_date: doc.insert_date || 'N/A',
                    name: doc.name || 'N/A',
                    file: doc.file ? `${DATABASE_URL}/${doc.file}` : '#'  // ໃຊ້ DATABASE_URL ກັບ file path
                }));
        
                const filteredDocuments = processedDocuments.filter(doc => {
                    const docDate = new Date(doc.insert_date);
                    return (!formatFilter || doc.format_id.toString() === formatFilter) &&
                           (!startDateFilter || docDate >= new Date(startDateFilter)) &&
                           (!endDateFilter || docDate <= new Date(endDateFilter));
                });
        
                return filteredDocuments;
        
            } catch (error) {
                console.error("Error fetching API data:", error);
                return [];
            }
        }
        
        function renderTable(documents) {
            const userRole = localStorage.getItem("user_role");
            if ($.fn.DataTable.isDataTable("#dataTable")) {
                $("#dataTable").DataTable().destroy();
            }
        
            const tableBody = document.getElementById("dataTableBody");
            tableBody.innerHTML = '';
        
            if (!documents?.length) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center">ບໍ່ພົບຂໍ້ມູນ</td></tr>';
                return;
            }
        
            const fragment = document.createDocumentFragment();
            documents.forEach((doc, index) => {
                const tr = document.createElement('tr');
                tr.dataset.id = doc.docg_id;  
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${doc.doc_number || ''}</td>
                    <td>${doc.format_name || ''}</td>
                    <td>${doc.subject || ''}</td>
                    <td>${doc.insert_date || ''}</td>                      
                    <td>${doc.name || ''}</td>
                    <td>
                        <a href="${doc.file}" target="_blank" class="btn btn-sm btn-link btn-view-doc">
                            <i class="fas fa-file"></i>
                        </a>
                    </td>               
                    <td class="text-center">
                        <a href="/update_documentGen/${doc.docg_id}" class="btn btn-sm btn-link" title="ແກ້ໄຂ">
                            <i class="fas fa-edit text-success"></i>
                        </a>
                        ${userRole === "admin" ? `
                        <button class="btn btn-sm btn-link delete-btn" data-id="${doc.docg_id}" title="ລືບ">
                            <i class="fas fa-trash-alt text-danger"></i>
                        </button>` : ""}
                    </td>
                `;
                fragment.appendChild(tr);
            });
        
            tableBody.appendChild(fragment);
            $(document).ready(function() {
                $('#dataTable').DataTable({
                    "pageLength": 10,
                    "order": [[0, "asc"]]
                });
                // $(".dataTables_filter").insertBefore(".dataTables_wrapper");
            });
    
            // ເພີ່ມ event listener ສຳລັບປຸ່ມລຶບ
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    deleteDocument(this.dataset.id);
                });
            });
        }
        
        async function deleteDocument(docId) {
            const apiUrl = `${DATABASE_URL}/api/document_general/${docId}/`;
        
            Swal.fire({
                title: "ທ່ານແນ່ໃຈບໍ?",
                text: "ທ່ານຈະບໍ່ສາມາດກູ້ຂໍ້ມູນຄືນໄດ້!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "ຢືນຢັນ",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(apiUrl, { method: 'DELETE' })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(() => {
                            // ລຶບຕົວແບບຈາກ DataTable ໂດຍບໍ່reload
                            const table = $('#dataTable').DataTable();
                            table.row($(`tr[data-id="${docId}"]`)).remove().draw();
                            Swal.fire("ລຶບສຳເລັດ!", "ເອກະສານໄດ້ຖືກລຶບແລ້ວ.", "success");
                            location.reload();
                        })
                        .catch(error => {
                            Swal.fire("Error!", `ລຶບເອກະສານບໍ່ສຳເລັດ: ${error.message}`, "error");
                        });
                }
            });
        }
        
        const documents = await fetchData();
        renderTable(documents);
    });
    function goBack() {
    window.history.back(); 
}
</script>

{% endblock %}
