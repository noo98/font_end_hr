{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    .table-responsive {
        max-height: 500px;
        overflow-y: auto;
    }
    .table th, .table td {
        white-space: nowrap;
        vertical-align: middle;
    }
    .main-container {
        padding: 20px;
    }
    .header-card {
        margin-bottom: 20px;
        background-color: #ffffff;
    }
    .table-card {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
</style>
<body>
    <div class="container-fluid main-container">
        <div class="row">
            <div class="col-12">
                <div class="card header-card">
                    <div class="card-body text-center">
                        <h1 class="card-title">
                            ລາຍງານຂໍ້ມູນການຈ່າຍເງິນເດືອນ
                        </h1>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card table-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">ລາຍງານຂໍ້ມູນ</h3>
                        <div>
                            <button class="btn btn-outline-success me-2" onclick="exportToExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Export Excel
                            </button>
                            <button class="btn btn-outline-info me-2" onclick="printTable()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="monlyTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ວັນທີ</th>
                                        <th>ພະນັກງານ</th>
                                        <th>ຕຳແໜ່ງ</th>
                                        <th>ເງິນເດືອນ</th>
                                        <th>ສະວັດດີການ 8%</th>
                                        <th>ສະວັດດີການ 5.5%</th>
                                        <th>ສະວັດດີການ 8.5%</th>
                                        <th>ສະວັດດີການ 6%</th>
                                        <th>ເງິນອຸໜູນຕຳແໜ່ງ</th>
                                        <th>ປີການ</th>
                                        <th>ເງິນປີການ</th>
                                        <th>ເງິນປີການລວມ</th>
                                        <th>ເງິນໂອທີ</th>
                                        <th>ລວມລາຍຮັບພື້ນຖານ</th>
                                        <th>ຄ່ານ້ຳມັນ</th>
                                        <th>ລາຍຮັບປະຈຳ</th>
                                        <th>ລາຍຮັບອື່ນ</th>
                                        <th>ລາຍຮັບກ່ອນພາສີ</th>
                                        <th>ຍົກຍົກພາສີ</th>
                                        <th>ພາສີ 5%</th>
                                        <th>ພາສີ 10%</th>
                                        <th>ພາສີ 15%</th>
                                        <th>ພາສີລວມ</th>
                                        <th>ລາຍຮັບສຸດທິພື້ນຖານ</th>
                                        <th>ຈຳນວນລູກ</th>
                                        <th>ເງິນອຸດໜູນລູກ</th>
                                        <th>ເງິນອຸດໜູນລູກລວມ</th>
                                        <th>ເງິນອຸດໜູນສຸຂະພາບ</th>
                                        <th>ເງິນສັງຄົມ</th>
                                        <th>ດອກເບ້ຍ</th>
                                        <th>ເງິນຝາກ</th>
                                        <th>ລວມເງິນສັງຄົມ</th>
                                        <th>ເງິນສຸດທິ</th>
                                    </tr>
                                </thead>
                                <tbody id="monlyTableBody">
                                    <tr id="loadingRow">
                                        <td colspan="34" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <div class="mt-2">ກຳລັງໂຫຼດຂໍ້ມູນ...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-center">
                        <p class="text-muted mb-0">
                            ລາຍງານນີ້ສໍາລັບການຈ່າຍເງິນເດືອນ ແລະ ຂໍ້ມູນອື່ນໆ.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch data from API and populate table
        async function fetchData() {
            try {
                const response = await fetch('http://192.168.45.52:8000/api/mon_ly/');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                populateTable(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loadingRow').innerHTML = `
                    <td colspan="34" class="text-center py-4 text-danger">
                        ມີຂໍ້ຜິດພາດໃນການໂຫຼດຂໍ້ມູນ: ${error.message}
                    </td>`;
            }
        }

        // Populate table with API data
        function populateTable(data) {
            const tbody = document.getElementById('monlyTableBody');
            tbody.innerHTML = ''; // Clear loading row
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="34" class="text-center py-4">
                            ບໍ່ມີຂໍ້ມູນທີ່ຈະສະແດງ
                        </td>
                    </tr>`;
                return;
            }

            data.forEach((item, index )=> {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.lao_name}</td>
                    <td>${item.position}</td>
                    <td>${formatNumber(item.salary)}</td>
                    <td>${formatNumber(item.wf_8)}</td>
                    <td>${formatNumber(item.wf_5_5)}</td>
                    <td>${formatNumber(item.wf_8_5)}</td>
                    <td>${formatNumber(item.wf_6)}</td>
                    <td>${formatNumber(item.position_subsidy)}</td>
                    <td>${item.age}</td>
                    <td>${formatNumber(item.year_subsidy)}</td>
                    <td>${formatNumber(item.year_subsidy_total)}</td>
                    <td>${formatNumber(item.ot)}</td>
                    <td>${formatNumber(item.basic_income)}</td>
                    <td>${formatNumber(item.fuel)}</td>
                    <td>${formatNumber(item.regular_income)}</td>
                    <td>${formatNumber(item.other_income)}</td>
                    <td>${formatNumber(item.income_before_tax)}</td>
                    <td>${formatNumber(item.exempt)}</td>
                    <td>${formatNumber(item.tax_5)}</td>
                    <td>${formatNumber(item.tax_10)}</td>
                    <td>${formatNumber(item.tax_15)}</td>
                    <td>${formatNumber(item.total_tax)}</td>
                    <td>${formatNumber(item.net_basic_income)}</td>
                    <td>${item.child}</td>
                    <td>${formatNumber(item.child_Subsidy)}</td>
                    <td>${formatNumber(item.child_subsidy_total)}</td>
                    <td>${formatNumber(item.health_Subsidy)}</td>
                    <td>${formatNumber(item.loan)}</td>
                    <td>${formatNumber(item.interest)}</td>
                    <td>${formatNumber(item.deposit)}</td>
                    <td>${formatNumber(item.saving_total)}</td>
                    <td>${formatNumber(item.net_salary)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Format number with commas
        function formatNumber(num) {
            return new Intl.NumberFormat('lo-LA', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num);
        }
        const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric'
                });
            };
        // Export table to Excel
        function exportToExcel() {
            const table = document.getElementById('monlyTable');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Monthly Report');
            XLSX.write(wb, 'xlsx', 'monthly_salary_report.xlsx');
        }

        // Print table
        function printTable() {
            const table = document.getElementById('monlyTable').outerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Print Report</title>
                        <style>
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                            th { background-color: #f2f2f2; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        <h1 style="text-align: center;">ລາຍງານຂໍ້ມູນການຈ່າຍເງິນເດືອນ</h1>
                        ${table}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>

</body>
{% endblock %}