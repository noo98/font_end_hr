{% extends "base.html" %}
{% load static %}

<title>Lcic-HR</title>

{% block content %}
<div class="container-fluid">
    <div class="row mx-3">
        <!-- Form Section -->
        <div class="col-md-4">
            <fieldset class="border border-primary p-2 px-4 pb-4" style="border-radius: 15px; background-color: #E7E9EB">
                <legend class="float-none w-auto p-2 h5">‡ªÄ‡∫û‡∫µ‡ªà‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ</legend>
                <form id="registerForm">
                    {% csrf_token %}
                    <input type="hidden" id="id" name="id">
                    
                    <div class="mb-3">
                        <input type="text" class="form-control" id="username" name="username" 
                               placeholder="‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ..." required>
                    </div>
                    
                    <div class="mb-3">
                        <input type="password" class="form-control" id="pwd" name="pwd" 
                               placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô..." required>
                    </div>
                    
                    <div class="mb-3">
                        <input type="text" class="form-control" id="empname" name="empname" 
                               placeholder="‡∫ä‡∫∑‡ªà‡∫û‡∫∞‡∫ô‡∫±‡∫Å‡∫á‡∫≤‡∫ô..." list="employeeList" 
                               oninput="setDepartment()" required>
                        <datalist id="employeeList"></datalist>
                    </div>
                    
                    <div class="mb-3">
                        <input type="text" class="form-control" id="depname" name="depname" 
                               placeholder="‡∫ä‡∫∑‡ªà‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å..." readonly required>
                    </div>
                    
                    <div class="mb-3">
                        <select class="form-select" id="status" name="status" required>
                            <option value="">‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞</option>
                            <option value="1">Admin</option>
                            <option value="2">User MM</option>
                            <option value="3">User IT</option>
                            <option value="4">User OP</option>
                            <option value="5">User DQ</option>
                        </select>
                    </div>
                    
                    <div class="row mt-4" style="justify-content: center;">
                        <button type="submit" name="btnEdit" class="btn btn-info" 
                                style="width: 110px; border-radius: 20px; display: none;">
                            <i class="fas fa-edit"></i>&nbsp;&nbsp;‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç
                        </button>
                        <button type="submit" name="btnAdd" class="btn btn-primary mx-2" 
                                style="width: 110px; border-radius: 20px;">
                            <i class="fas fa-plus-circle"></i>&nbsp;&nbsp;‡ªÄ‡∫û‡∫µ‡ªà‡∫°
                        </button>
                        <button type="reset" id="btnCancel" class="btn btn-warning mx-2" 
                                style="width: 110px; border-radius: 20px;">
                            <i class="fas fa-sync"></i>&nbsp;&nbsp;‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å
                        </button>
                    </div>
                </form>
            </fieldset>
        </div>

        <!-- Table Section -->
        <div class="col-md-8 mt-4">
            <fieldset class="border border-primary p-2 px-4 pb-4" style="border-radius: 15px;">
                <table id="example" class="table table-striped" style="width:100%">
                    <thead class="bg-secondary text-white">
                        <tr>
                            <th class="text-center">‡∫•‡ªç‡∫≤‡∫î‡∫±‡∫ö</th>
                            <th>‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ</th>
                            <th>‡∫ä‡∫∑‡ªà‡∫û‡∫∞‡∫ô‡∫±‡∫Å‡∫á‡∫≤‡∫ô</th>
                            <th>‡∫ä‡∫∑‡ªà‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å</th>
                            <th>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞</th>
                            <th class="text-center">Option</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for register in register %}
                        <tr>
                            <td class="text-center">{{ forloop.counter }}</td>
                            <td>{{ register.username }}</td>
                            <td>{{ register.employee_name }}</td>
                            <td>{{ register.department_name }}</td>
                            <td>{{ register.status }}</td>
                            <td class="text-center">
                                <a href="#" onclick="editRegister('{{ register.id }}')" 
                                   data-bs-toggle="tooltip" title="‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô">
                                    <i class="fas fa-edit text-success"></i>
                                </a>
                                <a href="#" onclick="deleteRegister('{{ register.id }}')" 
                                   data-bs-toggle="tooltip" title="‡∫•‡∫∑‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô">
                                    <i class="fas fa-trash-alt text-danger"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-danger">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </fieldset>
        </div>
    </div>
</div>

<!-- Scripts -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const API_BASE_URL = 'http://192.168.45.71:8000/api';

let departments = {};

        async function fetchData() {
            // 1. ‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å
            const depResponse = await fetch(`${API_BASE_URL}/list/departments/`);
            const depData = await depResponse.json();
            depData.forEach(dep => {
                departments[dep.id] = dep.name; // ‡∫™‡ªâ‡∫≤‡∫á‡ªÅ‡∫°‡∫ö‡∫Ñ‡∫ß‡∫≤‡∫°‡∫™‡∫≥‡∫û‡∫±‡∫ô ‡∫•‡∫∞‡∫´‡∫±‡∫î -> ‡∫ä‡∫∑‡ªà
            });

            // 2. ‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫û‡∫∞‡∫ô‡∫±‡∫Å‡∫á‡∫≤‡∫ô
            const empResponse = await fetch(`${API_BASE_URL}/employee/`);
            const employees = await empResponse.json();
            console.log(" Employees:", employees);
            let dataList = document.getElementById("employeeList");
            employees.forEach(emp => {
                let option = document.createElement("option");
                option.value = emp.lao_name;
                option.setAttribute("data-emp-id", emp.emp_id);
                option.setAttribute("data-dep-id", emp.Department); // ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å ID ‡∫Ç‡∫≠‡∫á‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å
                dataList.appendChild(option);
            });
        }

        function setDepartment() {
            let input = document.getElementById("empname");
            let options = document.getElementById("employeeList").options;
            for (let option of options) {
                if (option.value === input.value) {
                    let depId = option.getAttribute("data-dep-id");
                    document.getElementById("depname").value = departments[depId] || "‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô";
                    break;
                }
            }
        }

        document.addEventListener("DOMContentLoaded", fetchData);

        document.getElementById("registerForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    // 1. ‡∫™‡ªâ‡∫≤‡∫á FormData ‡∫à‡∫≤‡∫Å‡∫ü‡ªâ‡∫≠‡∫°
    let formData = new FormData(this);

    // 2. ‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡ªÉ‡∫™‡ªà‡ªÉ‡∫ô‡∫ü‡∫≠‡∫°
    let username = formData.get("username");
    let password = formData.get("pwd");
    let empname = formData.get("empname");
    let department = formData.get("depname");
    let status = formData.get("status");

    // 3. ‡∫ä‡∫≠‡∫Å‡∫´‡∫≤ `emp_id` ‡∫Ç‡∫≠‡∫á Employee
    let employeeId = null;
    let employeeOptions = document.getElementById("employeeList").options;
    for (let option of employeeOptions) {
        if (option.value === empname) {
            employeeId = option.getAttribute("data-emp-id"); 
            break;
        }
    }
    console.log("üîπ Employee ID:", employeeId);
    if (!employeeId) {
        Swal.fire("‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î", "‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫û‡∫∞‡∫ô‡∫±‡∫Å‡∫á‡∫≤‡∫ô!", "error");
        return;
    }

    // 4. ‡∫ä‡∫≠‡∫Å‡∫´‡∫≤ `department_id` ‡∫Ç‡∫≠‡∫á‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å
    let departmentId = Object.keys(departments).find(key => departments[key] === department);
    if (!departmentId) {
        Swal.fire("‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î", "‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å!", "error");
        return;
    }

    // 5. ‡∫™‡ªâ‡∫≤‡∫á JSON ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫à‡∫∞‡∫™‡∫ª‡ªà‡∫á‡ªÑ‡∫õ API
    let requestData = {
        username: username,
        password: password, 
        status: parseInt(status), 
        Department: parseInt(departmentId),
        Employee: parseInt(employeeId)
    };

    console.log("üîπ Data to send:", requestData);

    // 6. ‡∫™‡∫ª‡ªà‡∫á‡∫Ñ‡ªà‡∫≤‡ªÑ‡∫õ API
    try {
        let response = await fetch("http://192.168.45.71:8000/api/users/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            body: JSON.stringify(requestData)
        });

        let result = await response.json();
        console.log(" API Response:", result);

        if (response.ok) {
            Swal.fire({
                title: "‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!",
                text: "‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î",
                icon: "success"
            }).then(() => {
                location.reload();  
            });

            document.getElementById("registerForm").reset(); 
        } else {
                Swal.fire("‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î", result.message || "‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ‡ªÑ‡∫î‡ªâ", "error");
        }
    } catch (error) {
        console.error(" API Error:", error);
        Swal.fire("‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î", "‡ªÄ‡∫Å‡∫µ‡∫î‡∫ö‡∫±‡∫ô‡∫´‡∫≤‡ªÉ‡∫ô‡∫•‡∫∞‡∫ö‡∫ª‡∫ö", "error");
    }
});

</script>
{% endblock %}